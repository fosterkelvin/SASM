<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SASM Deployment Diagnostic</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 900px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #c00;
        border-bottom: 3px solid #c00;
        padding-bottom: 10px;
      }
      .status {
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        font-family: monospace;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }
      button {
        background: #c00;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px 5px;
      }
      button:hover {
        background: #a00;
      }
      #results {
        margin-top: 20px;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        background: #f9f9f9;
        border-left: 4px solid #c00;
      }
      .code {
        background: #2d2d2d;
        color: #f8f8f2;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç SASM Deployment Diagnostic Tool</h1>
      <p>
        This tool will check your production deployment configuration and
        identify issues.
      </p>

      <div class="section">
        <h3>Step 1: Enter Your Backend URL</h3>
        <input
          type="text"
          id="backendUrl"
          placeholder="https://your-backend.onrender.com"
          style="width: 100%; padding: 10px; font-size: 14px"
        />
        <small>This is your Render backend URL</small>
      </div>

      <button onclick="runDiagnostics()">üöÄ Run Diagnostics</button>
      <button onclick="testLogin()">üîê Test Login Flow</button>
      <button onclick="clearAndReset()">üßπ Clear Everything & Reset</button>

      <div id="results"></div>
    </div>

    <script>
      async function runDiagnostics() {
          const results = document.getElementById('results');
          results.innerHTML = '<h2>üîç Running Diagnostics...</h2>';

          let html = '';

          // Check 1: Frontend Environment
          html += '<div class="section"><h3>1Ô∏è‚É£ Frontend Configuration</h3>';
          const apiUrl = import.meta?.env?.VITE_API || 'NOT DEFINED';
          const mode = import.meta?.env?.MODE || 'unknown';

          if (apiUrl === 'NOT DEFINED' || apiUrl.includes('localhost')) {
              html += `<div class="status error">‚ùå VITE_API is ${apiUrl}<br>Should be your production backend URL!</div>`;
          } else {
              html += `<div class="status success">‚úÖ VITE_API: ${apiUrl}</div>`;
          }
          html += `<div class="status info">Mode: ${mode}</div>`;
          html += '</div>';

          // Check 2: Cookies
          html += '<div class="section"><h3>2Ô∏è‚É£ Cookies Status</h3>';
          const cookies = document.cookie;
          if (!cookies) {
              html += '<div class="status error">‚ùå No cookies found! This is the main issue.</div>';
              html += '<div class="status warning">‚ö†Ô∏è Possible causes:<br>1. Not logged in<br>2. CORS not configured<br>3. Cookie settings wrong on backend</div>';
          } else {
              const hasAccessToken = cookies.includes('accessToken');
              const hasRefreshToken = cookies.includes('refreshToken');

              if (hasAccessToken && hasRefreshToken) {
                  html += '<div class="status success">‚úÖ Both accessToken and refreshToken present</div>';
              } else if (hasAccessToken) {
                  html += '<div class="status warning">‚ö†Ô∏è Only accessToken present (refreshToken missing)</div>';
              } else {
                  html += '<div class="status error">‚ùå Cookies exist but access tokens missing</div>';
              }
              html += `<div class="status info">Cookies: ${cookies}</div>`;
          }
          html += '</div>';

          // Check 3: Backend Connection
          html += '<div class="section"><h3>3Ô∏è‚É£ Backend Connection Test</h3>';
          const backendUrl = document.getElementById('backendUrl').value || apiUrl;

          if (backendUrl && backendUrl !== 'NOT DEFINED') {
              try {
                  const healthResponse = await fetch(`${backendUrl}/`, {
                      credentials: 'include'
                  });
                  const healthData = await healthResponse.json();

                  if (healthData.status === 'healthy') {
                      html += '<div class="status success">‚úÖ Backend is reachable and healthy</div>';
                  } else {
                      html += '<div class="status warning">‚ö†Ô∏è Backend responded but status unclear</div>';
                  }
              } catch (error) {
                  html += `<div class="status error">‚ùå Cannot reach backend: ${error.message}</div>`;
                  html += '<div class="status warning">‚ö†Ô∏è Check if backend URL is correct and backend is running</div>';
              }
          } else {
              html += '<div class="status error">‚ùå Backend URL not configured</div>';
          }
          html += '</div>';

          // Check 4: User Endpoint
          html += '<div class="section"><h3>4Ô∏è‚É£ User Data Test</h3>';
          if (backendUrl && backendUrl !== 'NOT DEFINED') {
              try {
                  const userResponse = await fetch(`${backendUrl}/user`, {
                      credentials: 'include',
                      headers: {
                          'Content-Type': 'application/json'
                      }
                  });

                  if (userResponse.ok) {
                      const userData = await userResponse.json();
                      html += '<div class="status success">‚úÖ User endpoint responding</div>';
                      html += `<div class="code">${JSON.stringify(userData, null, 2)}</div>`;

                      if (userData.profileName) {
                          html += `<div class="status success">‚úÖ profileName found: "${userData.profileName}"</div>`;
                      } else {
                          html += '<div class="status error">‚ùå profileName is MISSING!</div>';
                          html += '<div class="status warning">‚ö†Ô∏è This is why "Profile: kel" is not showing<br>Solution: Clear sessions in database and re-login</div>';
                      }

                      if (userData.profileID) {
                          html += `<div class="status success">‚úÖ profileID found: ${userData.profileID}</div>`;
                      } else {
                          html += '<div class="status error">‚ùå profileID is MISSING!</div>';
                      }
                  } else if (userResponse.status === 401) {
                      html += '<div class="status warning">‚ö†Ô∏è 401 Unauthorized - Not logged in or token expired</div>';
                      html += '<div class="status info">Try logging in first</div>';
                  } else {
                      html += `<div class="status error">‚ùå User endpoint error: ${userResponse.status}</div>`;
                  }
              } catch (error) {
                  html += `<div class="status error">‚ùå User endpoint error: ${error.message}</div>`;
              }
          }
          html += '</div>';

          // Summary
          html += '<div class="section"><h3>üìã Summary & Next Steps</h3>';
          if (apiUrl.includes('localhost')) {
              html += '<div class="status error">‚ùå CRITICAL: VITE_API still pointing to localhost!</div>';
              html += '<div class="status warning">‚ö†Ô∏è Fix: Set VITE_API in Vercel environment variables</div>';
          }
          if (!cookies) {
              html += '<div class="status error">‚ùå CRITICAL: No cookies being set!</div>';
              html += '<div class="status warning">‚ö†Ô∏è Fix:<br>1. Set NODE_ENV=production on Render<br>2. Set APP_ORIGIN=https://sasm.site on Render<br>3. Redeploy backend</div>';
          }
          html += '</div>';

          results.innerHTML = html;
      }

      async function testLogin() {
          const results = document.getElementById('results');
          const backendUrl = document.getElementById('backendUrl').value || import.meta?.env?.VITE_API;

          if (!backendUrl || backendUrl === 'NOT DEFINED') {
              results.innerHTML = '<div class="status error">‚ùå Please enter backend URL first!</div>';
              return;
          }

          const email = prompt('Enter your email:');
          const password = prompt('Enter your password:');

          if (!email || !password) return;

          results.innerHTML = '<h2>üîê Testing Login...</h2>';

          try {
              const response = await fetch(`${backendUrl}/auth/signin`, {
                  method: 'POST',
                  credentials: 'include',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ email, password })
              });

              const data = await response.json();

              let html = '<div class="section"><h3>Login Response</h3>';
              html += `<div class="status ${response.ok ? 'success' : 'error'}">${response.ok ? '‚úÖ' : '‚ùå'} Status: ${response.status}</div>`;
              html += `<div class="code">${JSON.stringify(data, null, 2)}</div>`;
              html += '</div>';

              html += '<div class="section"><h3>Cookies After Login</h3>';
              const cookiesAfter = document.cookie;
              if (cookiesAfter) {
                  html += `<div class="status success">‚úÖ Cookies set!</div>`;
                  html += `<div class="status info">${cookiesAfter}</div>`;
              } else {
                  html += '<div class="status error">‚ùå NO COOKIES SET! This is the problem!</div>';
                  html += '<div class="status warning">‚ö†Ô∏è Backend is not setting cookies properly<br>Check:<br>1. NODE_ENV=production<br>2. APP_ORIGIN includes your frontend URL<br>3. COOKIE_DOMAIN is NOT set</div>';
              }
              html += '</div>';

              results.innerHTML = html;
          } catch (error) {
              results.innerHTML = `<div class="status error">‚ùå Login failed: ${error.message}</div>`;
          }
      }

      async function clearAndReset() {
          // Clear cookies
          document.cookie.split(";").forEach((c) => {
              document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
          });

          // Clear localStorage
          localStorage.clear();

          // Clear sessionStorage
          sessionStorage.clear();

          const results = document.getElementById('results');
          results.innerHTML = `
              <div class="section">
                  <h3>‚úÖ Cleared!</h3>
                  <div class="status success">
                      ‚úÖ All cookies cleared<br>
                      ‚úÖ localStorage cleared<br>
                      ‚úÖ sessionStorage cleared
                  </div>
                  <div class="status info">
                      Next steps:<br>
                      1. Close all tabs of this site<br>
                      2. Open a new incognito window<br>
                      3. Sign in again<br>
                      4. Select profile with PIN
                  </div>
              </div>
          `;
      }

      // Auto-fill backend URL if available
      window.addEventListener('load', () => {
          const apiUrl = import.meta?.env?.VITE_API;
          if (apiUrl && !apiUrl.includes('localhost')) {
              document.getElementById('backendUrl').value = apiUrl;
          }
      });
    </script>
  </body>
</html>
